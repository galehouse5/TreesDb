<?xml version="1.0" encoding="utf-8" ?>
<hibernate-mapping xmlns="urn:nhibernate-mapping-2.2"
                   assembly="TMD.Model"
                   namespace="TMD.Model.Photos" 
                   schema="Photos"
                   auto-import="false">
  
  <class name="PhotoStoreBase" table="Stores" abstract="true" >
    <id name="Id">
      <generator class="native" />
    </id>
    <discriminator column="Type"/>
    <property name="IsActive" />
    <subclass name="DiskPhotoStore" discriminator-value="2">
      <property name="RootPath" />
    </subclass>
  </class>

  <class name="Photo" table="Photos">
    <id name="Id">
      <generator class="native" />
    </id>
    <property name="Created" />
    <many-to-one name="Creator" column="CreatorUserId" cascade="none" />
    <component name="Size">
      <property name="Height" />
      <property name="Width" />
    </component>
    <property name="Bytes" />
    <property name="Format" />
    <many-to-one name="PermanentStore" column="StoreId" />
    <bag name="Links" table="Links" cascade="all-delete-orphan" inverse="true">
      <key column="PhotoId"></key>
      <one-to-many class="PhotoLinkBase"/>
    </bag>
  </class>

  <class name="PhotoLinkBase" abstract="true" table="Links">
    <id name="Id">
      <generator class="native" />
    </id>
    <discriminator column="Type"/>
    <many-to-one name="Photo" column="PhotoId" cascade="all" ></many-to-one>
    <subclass name="PublicPhotoLink" discriminator-value="1"></subclass>
    <subclass name="ImportPhotoLink" discriminator-value="2">
      <many-to-one name="Trip" column="TripId"></many-to-one>
    </subclass>
    <subclass name="SitePhotoLink" discriminator-value="3">
      <many-to-one name="Site" column="SiteId"></many-to-one>
    </subclass>
    <subclass name="TreePhotoLink" discriminator-value="4">
      <many-to-one name="Tree" column="TreeId"></many-to-one>
    </subclass>
  </class>
  
</hibernate-mapping>